---
title: Swift闭包
date: 2021-12-16 18:10:30
tags:
---
<!-- > 1. 什么是闭包？闭包值捕获？闭包的生命周期？
> 2. 尾随闭包？
> 3. 逃逸闭包？应用场景及目的？
> 4. 自动闭包？应用场景及目的？ -->

## 什么是闭包？(闭包 = 包含的函数代码块 + 所处的上下文环境)

闭包简单的说就是***自包含的函数代码块***以及***所处的上下文环境***。自包含的函数代码块其实就可以认为与匿名函数无异，而所处的上下文环境，却是闭包区别于匿名函数的地方，闭包可以捕获其所在上下文任意常量和变量的引用。Swift、OC等高级语言会为你管理捕获过程中涉及到的所有内存操作(值捕获)。

### Swift值捕获以及与OC值捕获的区别

闭包可以在其被定义的上下文中捕获常量和变量。即使定义这些常量和变量的原作用域已经不存在，闭包仍然可以在闭包函数体内引用和修改这些值。无论是Swift还是OC对于值的捕获都需要考虑两种情况，***值类型的捕获***与***引用类型的捕获***，下面就这两种情况分别说明

#### Swift 闭包值捕获

Swift中，可以捕获值的闭包的最简单形式是嵌套函数，也就是定义在其他函数的函数体内的函数。嵌套函数可以捕获其外部函数所有的参数以及定义的常量和变量。
***值类型捕获***：为了优化一个值不会被闭包改变，或者在闭包创建后不会改变，Swift可能会改为捕获并保存一份对值的拷贝；而其他情况，对于值类型，Swift应该同样是对值的引用。
***引用类型捕获***：直接引用地址，与OC并没有区别

具体体现可以看看代码：

```
    var i = 1
    let clourse = {
        i += 1
        print("闭包内: \(i)")
    }
    i += 1
    print("闭包外: \(i)")
    clourse()
    // 结果
    // 闭包外: 2
    // 闭包内: 3
```
#### OC Block值捕获

***值类型捕获***：OC中，对于值类型会直接保存一份对值的拷贝外部修改值，并不会影响block内部值的变化，也不能在Block内部直接修改，会报错。如果需要变化，则需要添加__block修饰符修饰此变量，将其在编译的时候转换一个结构体指针，这样就能同步修改block内外的值。(OC Block值捕获)；以上讨论的都是局部变量，对于全局变量、静态变脸、静态局部变量等就不同了;
***引用类型捕获***：直接引用地址，与Swift并没有区别。

具体体现可以看看代码：

```
    __block int i = 1;
    void(^block)(void) = ^{
        i += 1;
        NSLog(@"闭包内%d", i);
    };
    i += 1;
    NSLog(@"闭包外%d", i);
    block();
    // 结果
    // 闭包外: 2
    // 闭包内: 3
```

### Swift 闭包的类型以及OC Block类型

#### Swift 闭包的类型

##### 尾随闭包

##### 逃逸闭包

##### 自动闭包

#### OC Block类型

#### 栈Block

#### 堆Block

#### 全局Block